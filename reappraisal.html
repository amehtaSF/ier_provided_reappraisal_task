<!-- 
	Reappraisal Task Script

	Liz Song, <lizsong@stanford.edu>
	May, 2021
-->

<!DOCTYPE html>
<html>
  <head>
	<title>Reappraisal Script</title>
	<script src="jspsych-6.3.1/jspsych.js"></script>
	<script src="jspsych-6.3.1/plugins/jspsych-html-keyboard-response.js"></script>
	<script src="jspsych-6.3.1/plugins/jspsych-image-keyboard-response.js"></script>
	<script src="jspsych-6.3.1/plugins/jspsych-preload.js"></script>
	<script src="jspsych-6.3.1/plugins/jspsych-survey-likert.js"></script>
	<script src="jspsych-6.3.1/plugins/jspsych-survey-text.js"></script>
	<script src="jspsych-6.3.1/plugins/jspsych-instructions.js"></script>
	<link href="jspsych-6.3.1/css/jspsych.css" rel="stylesheet" type="text/css">
  </head>
  <body></body>
  
	<script type="text/javascript" src="imgReapp.js"></script>
  <script>


	/**
	 * Shuffles array in place. Based on Fisher-Yates Shuffle Algorithm 
	 * https://stackoverflow.com/questions/6274339/how-can-i-shuffle-an-array
	 * 
	 * @param {Array} a items An array containing the items.
	 */
	function shuffle(a) {
	    var j, x, i;
	    for (i = a.length - 1; i > 0; i--) {
	        j = Math.floor(Math.random() * (i + 1));
	        x = a[i];
	        a[i] = a[j];
	        a[j] = x;
	    }
	    return a;
	}

//  INITIALIZATION 
  	/* read JSON files for low and high intensity images (note: not technically a JSON file) */ 
  	var jsonObj_low = JSON.parse(reapp_low);
  	var jsonObj_high = JSON.parse(reapp_high);

	/* create timeline */
	var timeline = [];

	/* isolate image names from JSON file into arrays to preload */
  	var imgName_low = [];
  	var imgName_high = [];
  	jsonObj_low.forEach(function(entry){ 
    	imgName_low.push(entry.img); 
	});
  	jsonObj_high.forEach(function(entry){
  		imgName_high.push(entry.img);
  	});
		
	var preload = {
	  	type: 'preload',
	  	images: imgName_low.concat(imgName_high) 
	}
	timeline.push(preload);

	/* shuffles low and high intensity image arrays and partitions out 15 from each array into three blocks */
	var img_low = shuffle(jsonObj_low);
  var img_high = shuffle(jsonObj_high);

  var block1 = [];
  var block2 = [];
  var block3 = [];

  var i;
  for (i = 0; i < 15; i++) {
  	block1.push(img_low[i]);
  	block1.push(img_high[i]);
  }

  for (i = 15; i < 30; i++) {
  	block2.push(img_low[i]);
  	block2.push(img_high[i]);
  }

  for (i = 30; i < 45; i++) {
  	block3.push(img_low[i]);
  	block3.push(img_high[i]);
  }

  block1 = shuffle(block1);
  block2 = shuffle(block2);
  block3 = shuffle(block3);

	/* constant for self-gen or given reappraisal for between-subject questions */
	const rethinkPath = jsPsych.randomization.sampleWithReplacement([0, 1], 1)[0];

	/* constant for attend/rethink self-gen/rethink given conditions. 0 = attend; 1 = rethink given; 2 = rethink self-gen */ 
	var path = -1;
	

//  INTRO TO STUDY
	/* define welcome message trial */
	var welcome = {
	  type: 'html-keyboard-response',
	  stimulus: "Welcome to the experiment. Press any key on the keyboard to begin."
	};
	timeline.push(welcome);


//  TRAINING RETHINKING
	/* define rethinking explanation trial */
	var trainRethink = {
	  type: 'instructions',
	  pages: [
	  		"In this study you will view emotional images and attempt to change your emotion response.",
	 		"In a process called rethinking, you stop and review an initial emotional response to consider if that emotional response should be changed.",
	 		"A reappraisal is when you reframe an emotional situation to reduce the amount of negative emotion you may feel.",
	 		"Click next to move on to see a few example images and example reappraisals", 
	 		"<img src='img/blue.png'></img> <p>An example reappraisal would be: This is a blue circle<p>",
	 		"<img src='img/orange.png'></img> <p>An example reappraisal would be: This is an orange circle<p>"
	  ],
	  show_clickable_nav: true
	};
	timeline.push(trainRethink);


//  EXPLAINING TRIAL STRUCTURE
	/* define explaining study structure trial */
	var explain = {
	  type: 'instructions',
	  pages: [
	  	'<p>In this study, you will be asked to either attend to an image or rethink an image.<p>', 
	  	'<p>You will first be shown an image for 1 second.<p>',
	  	'<p>Then you will either attend to the image or rethink the image for 6 seconds. <p>',
	  	'<p>If you see "Attend," do not do anything for 6 seconds. <p>',
	  	function(){ 
	  		// between subject case: if 0, user is given appraisal; if 1, user thinks of their own 
			if (rethinkPath == 0) { 
				return '<p>If you see "Rethink," you will be given a reappraisal. Read it for the full length of the 6 seconds.<p>'; 
			} 
			else { 
				return '<p>If you see "Rethink," you will be asked to create your own reappraisal. Think of one for 6 seconds<p>'; 
			} 
		}, 
		'<p>Then you will be shown the initial image again for 6 seconds.<p>',
		'<p>You will be asked to fill out a two-question survey ranking the positive and negative emotions you feel about the image that you saw.<p>',
		'<p>For a select few images in the Rethink condition, you will also be asked to write down what reappraisal you thought about.<p>',
		'<p>Click next to see a sample of what the study will look like<p>'
		],
	  show_clickable_nav: true
	};
	timeline.push(explain);

	var step3_attend = {
	  type: 'html-keyboard-response',
	  stimulus: function(){ 
	  		path = 0;
			return "Attend";
		},
	  choices: jsPsych.NO_KEYS,
	  trial_duration: 6000
	};

	var step3_rethink = {
	  type: 'html-keyboard-response',
	  stimulus: function(){ 
			// between subject case: if 0, user is given appraisal; if 1, user thinks of their own
			if (rethinkPath == 0) {
				path = 1;
				return jsPsych.timelineVariable('reappraisal');
			}
			else {
				path = 2;
				return "Think of your own reapprasial";
			}
		},
	  choices: jsPsych.NO_KEYS,
	  trial_duration: 6000
	};

	var freewrite = {
		type: 'survey-text',
		questions: [{prompt: "What did you think about when you were viewing the picture?", rows: 5, columns: 40}]
	}


//  TEST TRIALS SETUP
	/* step 1: ask user to click to preview image */
	var step1 = {
	  type: "html-keyboard-response",
	  stimulus: "Press any key on the keyboard to preview the image"
	};

	/* step 2: preview image for 1 second */
	var step2 = {
	  type: "image-keyboard-response", 
	  stimulus: jsPsych.timelineVariable('img'),
	  choices: jsPsych.NO_KEYS,
	  trial_duration: 1000
	}

	/* step 3: have user attend or rethink the image */
	var step3 = {
	  type: 'html-keyboard-response',
	  stimulus: function(){ 
	  		// within subject case: if 0, user attends; if 1, user rethinks
			if (jsPsych.randomization.sampleWithReplacement([0, 1], 1)[0] == 0) {
				path = 0;
				return "Attend"; 
			}
			else {
				// between subject case: if 0, user is given appraisal; if 1, user thinks of their own
				if (rethinkPath == 0) {
					path = 1;
					return jsPsych.timelineVariable('reappraisal');
				}
				else {
					path = 2;
					return "Think of your own reapprasial";
				}
			}		
		},
	  choices: jsPsych.NO_KEYS,
	  trial_duration: 6000
	};	

	/* step 4: view image for six seconds */
	var step4 = {
	  type: 'image-keyboard-response',
	  stimulus: jsPsych.timelineVariable('img'),
	  choices: jsPsych.NO_KEYS,
	  trial_duration: 6000
	};

	/* step 5: have user rate their negative and positive emotions */
	var scale_pos = [ 
		"Not at all positive", 
		"Slightly positive", 
		"Moderately positive", 
		"Very positive", 
		"Extremely positive"
	];

	var scale_neg = [ 
		"Not at all negative", 
		"Slightly negative", 
		"Moderately negative", 
		"Very negative", 
		"Extremely negative"
	];

	var step5 = {
	  type: 'survey-likert',
	  questions: [
	  	{prompt: "How positive do you feel in response to this picture?", name: 'positive', labels: scale_pos},
		{prompt: "How negative do you feel in response to this picture?", name: 'negative', labels: scale_neg}
	  ],
	  randomize_question_order: false,
	  on_finish: function(data){
    	data.img = jsPsych.timelineVariable('img');
    	if (path == 0) {
    		data.path = "Attend";
    	} else if (path == 1) {
    		data.path = "Rethink given";
    	} else if (path ==2) {
    		data.path = "Rethink self-gen";
    	}
  	  }
	};


//  RUNNING EXPLANATION OF TRIAL STRUCTURE TIMELINE (FROM INTRODUCTION SETUP)
	/* explain trial structure timeline; attend */
	var trial_structure_attend = {
	  timeline: [step1, step2, step3_attend, step4, step5, freewrite],
	  timeline_variables: [
       	{ img: 'img/blue.png', reappraisal: 'This is a blue circle' },
       	{ img: 'img/orange.png', reappraisal: 'This is an orange circle' }
      ] 
	}
	timeline.push(trial_structure_attend);

	/* explain trial structure timeline; rethink */
	var trial_structure_rethink = {
	  timeline: [step1, step2, step3_rethink, step4, step5, freewrite],
	  timeline_variables: [
       	{ img: 'img/blue.png', reappraisal: 'This is a blue circle' },
       	{ img: 'img/orange.png', reappraisal: 'This is an orange circle' }
      ]  
	}
	timeline.push(trial_structure_rethink);


//  RUNNING EXPERIMENT TIMELINE
	var begin_experiment = {
	  type: 'html-keyboard-response',
	  stimulus: "The experiment will be on the next page. Press any key on the keyboard to begin."
	}
	timeline.push(begin_experiment);

	/* repeat test trials for block 1 of images */
	var test_procedure1 = {
	  timeline: [step1, step2, step3, step4, step5],
	  timeline_variables: block1
	}
	timeline.push(test_procedure1);

	var break1 = {
	  type: 'instructions',
	  pages: ["We have now finished Block 1. Click next to continue to Block 2."],
	  show_clickable_nav: true
	}
	timeline.push(break1);

	/* repeat test trials for block 2 of images */
	var test_procedure2 = {
	  timeline: [step1, step2, step3, step4, step5],
	  timeline_variables: block2
	}
	timeline.push(test_procedure2);

	var break2 = {
	  type: 'instructions',
	  pages: ["We have now finished Block 2. Click next to continue to Block 3."],
	  show_clickable_nav: true
	}
	timeline.push(break2);

	/* repeat test trials for block 3 of images */
	var test_procedure3 = {
	  timeline: [step1, step2, step3, step4, step5],
	  timeline_variables: block3
	}
	timeline.push(test_procedure3);

	var break3 = {
	  type: 'instructions',
	  pages: ["We have now finished Block 3. Thank you for your participation."],
	  show_clickable_nav: true
	}
	timeline.push(break3);

//  START EXPERIMENT
	/* start the experiment */
	jsPsych.init({
	  timeline: timeline
	});
  </script>
  </html>